<script setup lang="ts">
import { ref, computed } from 'vue'

interface FileNode {
  name: string
  type: 'file' | 'directory' | 'executable'
  size?: string
  description?: string
  warning?: boolean
  children?: FileNode[]
}

const fileTree = ref<FileNode>({
  name: 'my-project',
  type: 'directory',
  description: 'é¡¹ç›®æ ¹ç›®å½•',
  children: [
    {
      name: 'node_modules',
      type: 'directory',
      description: 'ä¾èµ–åŒ…ç›®å½• (è‡ªåŠ¨ç”Ÿæˆ)',
      children: [
        { name: '.bin', type: 'directory', description: 'å¯æ‰§è¡Œå‘½ä»¤' },
        { name: 'next', type: 'directory', description: 'Next.js æ¡†æ¶' },
        { name: 'react', type: 'directory', description: 'React åº“' },
        { name: 'react-dom', type: 'directory', description: 'React DOM' },
        { name: 'typescript', type: 'directory', description: 'TypeScript ç¼–è¯‘å™¨' },
        { name: '@types', type: 'directory', description: 'ç±»å‹å®šä¹‰' },
        { name: 'tailwindcss', type: 'directory', description: 'Tailwind CSS' }
      ]
    },
    {
      name: 'src',
      type: 'directory',
      description: 'æºä»£ç ç›®å½•',
      children: [
        {
          name: 'app',
          type: 'directory',
          description: 'Next.js App Router',
          children: [
            { name: 'page.tsx', type: 'file', size: '2.3KB', description: 'é¦–é¡µè·¯ç”±ç»„ä»¶' },
            { name: 'layout.tsx', type: 'file', size: '1.8KB', description: 'æ ¹å¸ƒå±€ç»„ä»¶' },
            { name: 'globals.css', type: 'file', size: '3.2KB', description: 'å…¨å±€æ ·å¼' },
            { name: 'loading.tsx', type: 'file', size: '0.8KB', description: 'åŠ è½½çŠ¶æ€ç»„ä»¶' },
            { name: 'error.tsx', type: 'file', size: '1.2KB', description: 'é”™è¯¯å¤„ç†ç»„ä»¶' },
            {
              name: 'dashboard',
              type: 'directory',
              description: 'ä»ªè¡¨ç›˜è·¯ç”±',
              children: [
                { name: 'page.tsx', type: 'file', size: '1.5KB', description: 'ä»ªè¡¨ç›˜é¡µé¢' },
                { name: 'layout.tsx', type: 'file', size: '0.9KB', description: 'ä»ªè¡¨ç›˜å¸ƒå±€' }
              ]
            },
            {
              name: 'api',
              type: 'directory',
              description: 'API è·¯ç”±',
              children: [
                { name: 'route.ts', type: 'file', size: '1.1KB', description: 'API ç«¯ç‚¹' }
              ]
            }
          ]
        },
        {
          name: 'components',
          type: 'directory',
          description: 'å¯å¤ç”¨ç»„ä»¶',
          children: [
            {
              name: 'ui',
              type: 'directory',
              description: 'UI åŸºç¡€ç»„ä»¶',
              children: [
                { name: 'button.tsx', type: 'file', size: '2.1KB', description: 'æŒ‰é’®ç»„ä»¶' },
                { name: 'card.tsx', type: 'file', size: '1.6KB', description: 'å¡ç‰‡ç»„ä»¶' },
                { name: 'input.tsx', type: 'file', size: '1.9KB', description: 'è¾“å…¥æ¡†ç»„ä»¶' },
                { name: 'modal.tsx', type: 'file', size: '2.4KB', description: 'å¼¹çª—ç»„ä»¶' }
              ]
            },
            {
              name: 'layout',
              type: 'directory',
              description: 'å¸ƒå±€ç»„ä»¶',
              children: [
                { name: 'header.tsx', type: 'file', size: '1.8KB', description: 'é¡¶éƒ¨å¯¼èˆª' },
                { name: 'sidebar.tsx', type: 'file', size: '2.2KB', description: 'ä¾§è¾¹æ ' },
                { name: 'footer.tsx', type: 'file', size: '1.3KB', description: 'é¡µè„š' }
              ]
            }
          ]
        },
        {
          name: 'lib',
          type: 'directory',
          description: 'å·¥å…·åº“',
          children: [
            { name: 'utils.ts', type: 'file', size: '0.6KB', description: 'å·¥å…·å‡½æ•°' },
            { name: 'api.ts', type: 'file', size: '1.4KB', description: 'API å®¢æˆ·ç«¯' },
            { name: 'constants.ts', type: 'file', size: '0.8KB', description: 'å¸¸é‡å®šä¹‰' }
          ]
        },
        {
          name: 'hooks',
          type: 'directory',
          description: 'è‡ªå®šä¹‰ Hooks',
          children: [
            { name: 'useAuth.ts', type: 'file', size: '1.2KB', description: 'è®¤è¯ Hook' },
            { name: 'useFetch.ts', type: 'file', size: '1.5KB', description: 'æ•°æ®è·å– Hook' }
          ]
        },
        {
          name: 'types',
          type: 'directory',
          description: 'ç±»å‹å®šä¹‰',
          children: [
            { name: 'index.ts', type: 'file', size: '0.9KB', description: 'å…¨å±€ç±»å‹' },
            { name: 'api.ts', type: 'file', size: '1.1KB', description: 'API ç±»å‹' }
          ]
        }
      ]
    },
    {
      name: 'public',
      type: 'directory',
      description: 'é™æ€èµ„æº',
      children: [
        { name: 'favicon.ico', type: 'file', size: '4KB' },
        { name: 'logo.svg', type: 'file', size: '2KB', description: 'Logo' },
        { name: 'robots.txt', type: 'file', size: '0.1KB', description: 'çˆ¬è™«è§„åˆ™' },
        {
          name: 'images',
          type: 'directory',
          description: 'å›¾ç‰‡èµ„æº',
          children: [
            { name: 'hero.png', type: 'file', size: '156KB' },
            { name: 'avatar.jpg', type: 'file', size: '24KB' }
          ]
        }
      ]
    },
    {
      name: '.next',
      type: 'directory',
      description: 'æ„å»ºè¾“å‡º (è‡ªåŠ¨ç”Ÿæˆ)',
      children: [
        { name: 'static', type: 'directory' },
        { name: 'server', type: 'directory' },
        { name: 'build-manifest.json', type: 'file', size: '12KB' }
      ]
    },
    {
      name: 'scripts',
      type: 'directory',
      description: 'è„šæœ¬æ–‡ä»¶',
      children: [
        { name: 'build.sh', type: 'executable', size: '0.5KB', description: 'æ„å»ºè„šæœ¬' },
        { name: 'deploy.sh', type: 'executable', size: '0.8KB', description: 'éƒ¨ç½²è„šæœ¬' }
      ]
    },
    {
      name: 'tests',
      type: 'directory',
      description: 'æµ‹è¯•æ–‡ä»¶',
      children: [
        { name: 'unit', type: 'directory', description: 'å•å…ƒæµ‹è¯•' },
        { name: 'e2e', type: 'directory', description: 'ç«¯åˆ°ç«¯æµ‹è¯•' }
      ]
    },
    {
      name: 'docs',
      type: 'directory',
      description: 'æ–‡æ¡£',
      children: [
        { name: 'README.md', type: 'file', size: '5KB' },
        { name: 'API.md', type: 'file', size: '8KB' }
      ]
    },
    {
      name: 'package.json',
      type: 'file',
      size: '2.4KB',
      description: 'é¡¹ç›®é…ç½® & ä¾èµ–'
    },
    {
      name: 'tsconfig.json',
      type: 'file',
      size: '1.2KB',
      description: 'TypeScript é…ç½®'
    },
    {
      name: 'next.config.js',
      type: 'file',
      size: '0.8KB',
      description: 'Next.js é…ç½®'
    },
    {
      name: 'tailwind.config.ts',
      type: 'file',
      size: '1.5KB',
      description: 'Tailwind é…ç½®'
    },
    {
      name: 'postcss.config.js',
      type: 'file',
      size: '0.3KB',
      description: 'PostCSS é…ç½®'
    },
    {
      name: 'eslint.config.mjs',
      type: 'file',
      size: '0.9KB',
      description: 'ESLint é…ç½®'
    },
    {
      name: 'prettier.config.js',
      type: 'file',
      size: '0.4KB',
      description: 'Prettier é…ç½®'
    },
    {
      name: 'vitest.config.ts',
      type: 'file',
      size: '0.7KB',
      description: 'Vitest æµ‹è¯•é…ç½®'
    },
    {
      name: '.env.local',
      type: 'file',
      size: '0.5KB',
      description: 'æœ¬åœ°ç¯å¢ƒå˜é‡ (ä¸æäº¤)'
    },
    {
      name: '.env.example',
      type: 'file',
      size: '0.4KB',
      description: 'ç¯å¢ƒå˜é‡ç¤ºä¾‹'
    },
    {
      name: '.gitignore',
      type: 'file',
      size: '0.6KB',
      description: 'Git å¿½ç•¥è§„åˆ™'
    },
    {
      name: 'README.md',
      type: 'file',
      size: '4.5KB',
      description: 'é¡¹ç›®è¯´æ˜æ–‡æ¡£'
    },
    {
      name: 'LICENSE',
      type: 'file',
      size: '1.1KB',
      description: 'è®¸å¯è¯'
    },
    {
      name: 'pnpm-lock.yaml',
      type: 'file',
      size: '245KB',
      description: 'ä¾èµ–é”å®šæ–‡ä»¶'
    }
  ]
})

const expandedNodes = ref<Set<string>>(new Set(['my-project', 'src', 'app']))
const selectedNode = ref<string | null>(null)
const showWarning = ref(false)

function toggleNode(node: FileNode, path: string) {
  if (node.type !== 'directory') {
    selectedNode.value = path
    return
  }

  if (expandedNodes.value.has(path)) {
    expandedNodes.value.delete(path)
  } else {
    expandedNodes.value.add(path)
  }
}

function isExpanded(path: string): boolean {
  return expandedNodes.value.has(path)
}

function getNodeIcon(node: FileNode): string {
  switch (node.type) {
    case 'directory': return 'ğŸ“'
    case 'executable': return 'âš¡'
    default: return 'ğŸ“„'
  }
}

function getNodeClass(node: FileNode): string {
  const classes = [node.type]
  if (node.warning) classes.push('warning')
  return classes.join(' ')
}

function checkPathName(name: string): boolean {
  // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡æˆ–ç©ºæ ¼
  return /[\u4e00-\u9fa5\s]/.test(name)
}

function showPathWarning() {
  showWarning.value = true
  setTimeout(() => showWarning.value = false, 3000)
}

function renderTree(node: FileNode, path: string = '', level: number = 0): { node: FileNode, path: string, level: number, isLast: boolean }[] {
  const currentPath = path ? `${path}/${node.name}` : node.name
  const result: { node: FileNode, path: string, level: number, isLast: boolean }[] = []

  result.push({ node, path: currentPath, level, isLast: !node.children || node.children.length === 0 })

  if (node.children && isExpanded(currentPath)) {
    node.children.forEach((child, index) => {
      result.push(...renderTree(child, currentPath, level + 1))
    })
  }

  return result
}

const flattenedTree = computed(() => renderTree(fileTree.value))
</script>

<template>
  <div class="fs-tree">
    <div class="tree-window">
      <!-- æ ‡é¢˜æ  -->
      <div class="tree-header">
        <div class="window-controls">
          <span class="control close"></span>
          <span class="control minimize"></span>
          <span class="control maximize"></span>
        </div>
        <div class="tree-title">
          <svg class="tree-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
          é¡¹ç›®æ–‡ä»¶ç»“æ„
        </div>
        <div class="tree-actions">
          <button class="action-btn" @click="showPathWarning" title="è·¯å¾„è§„èŒƒæ£€æŸ¥">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
              <line x1="12" y1="9" x2="12" y2="13"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- è­¦å‘Šæç¤º -->
      <div v-if="showWarning" class="warning-banner">
        <span class="warning-icon">âš ï¸</span>
        <div class="warning-content">
          <strong>è·¯å¾„è§„èŒƒæé†’</strong>
          <span>æ–‡ä»¶å¤¹å’Œæ–‡ä»¶ååº”é¿å…ä½¿ç”¨ä¸­æ–‡å’Œç©ºæ ¼ï¼Œä»¥é˜²æ­¢å·¥å…·æŠ¥é”™ã€‚</span>
        </div>
      </div>

      <!-- æ–‡ä»¶æ ‘ -->
      <div class="tree-content">
        <div
          v-for="item in flattenedTree"
          :key="item.path"
          class="tree-node"
          :class="{
            selected: selectedNode === item.path,
            expandable: item.node.type === 'directory',
            expanded: isExpanded(item.path)
          }"
          :style="{ paddingLeft: `${item.level * 20 + 12}px` }"
          @click="toggleNode(item.node, item.path)"
        >
          <!-- å±•å¼€/æŠ˜å æŒ‡ç¤ºå™¨ -->
          <span v-if="item.node.type === 'directory'" class="expand-icon">
            {{ isExpanded(item.path) ? 'â–¼' : 'â–¶' }}
          </span>
          <span v-else class="expand-icon placeholder"></span>

          <!-- æ–‡ä»¶å›¾æ ‡ -->
          <span class="node-icon">{{ getNodeIcon(item.node) }}</span>

          <!-- æ–‡ä»¶å -->
          <span
            class="node-name"
            :class="{ 'has-warning': checkPathName(item.node.name) }"
          >
            {{ item.node.name }}
          </span>

          <!-- æ–‡ä»¶å¤§å° -->
          <span v-if="item.node.size" class="node-size">{{ item.node.size }}</span>

          <!-- æè¿° -->
          <span v-if="item.node.description" class="node-desc">{{ item.node.description }}</span>

          <!-- ä¸­æ–‡/ç©ºæ ¼è­¦å‘Š -->
          <span v-if="checkPathName(item.node.name)" class="name-warning" title="åŒ…å«ä¸­æ–‡æˆ–ç©ºæ ¼">
            âš ï¸
          </span>
        </div>
      </div>

      <!-- åº•éƒ¨è¯´æ˜ -->
      <div class="tree-footer">
        <div class="footer-stats">
          <span class="stat-item">
            <span class="stat-icon">ğŸ“</span>
            ç›®å½•
          </span>
          <span class="stat-item">
            <span class="stat-icon">ğŸ“„</span>
            æ–‡ä»¶
          </span>
          <span class="stat-item">
            <span class="stat-icon">âš¡</span>
            å¯æ‰§è¡Œ
          </span>
        </div>
        <div class="footer-tip">
          ğŸ’¡ ç‚¹å‡»æ–‡ä»¶å¤¹å±•å¼€/æŠ˜å ï¼Œç‚¹å‡»æ–‡ä»¶æŸ¥çœ‹è¯¦æƒ…
        </div>
      </div>
    </div>

    <!-- è·¯å¾„è§„èŒƒæç¤º -->
    <div class="naming-guide">
      <div class="guide-title">
        <span>âœ…</span>
        <span>æ¨èå‘½åè§„èŒƒ</span>
      </div>
      <div class="guide-content">
        <div class="guide-item good">
          <span class="guide-marker">âœ“</span>
          <code>my-project</code>
          <span>ä½¿ç”¨è‹±æ–‡è¿å­—ç¬¦</span>
        </div>
        <div class="guide-item good">
          <span class="guide-marker">âœ“</span>
          <code>my_project</code>
          <span>ä½¿ç”¨ä¸‹åˆ’çº¿</span>
        </div>
        <div class="guide-item bad">
          <span class="guide-marker">âœ—</span>
          <code>æˆ‘çš„é¡¹ç›®</code>
          <span>é¿å…ä¸­æ–‡</span>
        </div>
        <div class="guide-item bad">
          <span class="guide-marker">âœ—</span>
          <code>my project</code>
          <span>é¿å…ç©ºæ ¼</span>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.fs-tree {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  margin: 20px 0;
}

.tree-window {
  background: #1e1e2e;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

/* Header */
.tree-header {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: linear-gradient(180deg, #2d2d44 0%, #1e1e2e 100%);
  border-bottom: 1px solid #2d2d44;
}

.window-controls {
  display: flex;
  gap: 8px;
}

.control {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

.control.close { background: #ff5f56; }
.control.minimize { background: #ffbd2e; }
.control.maximize { background: #27c93f; }

.tree-title {
  flex: 1;
  text-align: center;
  color: #a0a0b0;
  font-size: 13px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.tree-icon {
  width: 16px;
  height: 16px;
  color: #f6ad55;
}

.tree-actions {
  display: flex;
  gap: 8px;
}

.action-btn {
  background: transparent;
  border: none;
  color: #888;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s;
}

.action-btn:hover {
  color: #fff;
  background: rgba(255, 255, 255, 0.1);
}

.action-btn svg {
  width: 14px;
  height: 14px;
}

/* Warning Banner */
.warning-banner {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: linear-gradient(135deg, #744210 0%, #975a16 100%);
  color: #faf089;
  font-size: 13px;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.warning-icon {
  font-size: 20px;
}

.warning-content {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.warning-content strong {
  color: #fff;
}

/* Tree Content */
.tree-content {
  padding: 8px 0;
  max-height: 400px;
  overflow-y: auto;
}

.tree-node {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  color: #e2e8f0;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s;
  border-left: 2px solid transparent;
}

.tree-node:hover {
  background: #252542;
}

.tree-node.selected {
  background: #2c5282;
  border-left-color: #63b3ed;
}

.expand-icon {
  width: 14px;
  text-align: center;
  font-size: 10px;
  color: #718096;
  transition: transform 0.2s;
}

.expand-icon.placeholder {
  visibility: hidden;
}

.node-icon {
  font-size: 14px;
}

.node-name {
  font-family: 'SF Mono', Monaco, monospace;
}

.node-name.has-warning {
  color: #f6ad55;
}

.node-size {
  margin-left: auto;
  font-size: 11px;
  color: #718096;
  font-family: 'SF Mono', Monaco, monospace;
}

.node-desc {
  margin-left: 8px;
  font-size: 11px;
  color: #718096;
}

.name-warning {
  font-size: 12px;
  color: #f6ad55;
  cursor: help;
}

/* Footer */
.tree-footer {
  padding: 12px 16px;
  background: #16162a;
  border-top: 1px solid #2d2d44;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}

.footer-stats {
  display: flex;
  gap: 16px;
}

.stat-item {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: #a0aec0;
}

.stat-icon {
  font-size: 12px;
}

.footer-tip {
  font-size: 11px;
  color: #718096;
}

/* Naming Guide */
.naming-guide {
  margin-top: 16px;
  padding: 16px;
  background: #f7fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
}

.guide-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 12px;
}

.guide-content {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
}

.guide-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 13px;
}

.guide-item.good {
  background: #f0fff4;
}

.guide-item.bad {
  background: #fff5f5;
}

.guide-marker {
  width: 18px;
  height: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-size: 11px;
  font-weight: 600;
}

.guide-item.good .guide-marker {
  background: #48bb78;
  color: white;
}

.guide-item.bad .guide-marker {
  background: #f56565;
  color: white;
}

.guide-item code {
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 12px;
  padding: 2px 6px;
  background: #fff;
  border-radius: 4px;
  border: 1px solid #e2e8f0;
}

.guide-item span:last-child {
  color: #718096;
  font-size: 12px;
}

@media (max-width: 480px) {
  .guide-content {
    grid-template-columns: 1fr;
  }
}
</style>
